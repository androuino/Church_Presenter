m2d2.load(e=>{e.dict.set({yes:{en:"YES"},no:{en:"NO"},ok:{en:"OK"},send:{en:"SEND"},cancel:{en:"CANCEL"}})}),m2d2.ready(e=>{let t=null,n=.7;const o=e("#splashScreen"),i=e("#main"),s=document.querySelector("#lyrics"),a=e("#mediaContainer"),l=e("#info",{show:!1}),r=new EventSource("/events");e("body",{onload:function(t){setTimeout(function(){o.style.display="none",i.style.display="flex",l.show=!0,d("assets/tiny.mp4"),e.get("/getip",e=>{console.log(e),e.ok&&"connected"===e.data.status&&(l.textContent=e.data.ip)},e=>{console.error("Error getting ip.",e)},!0)},3e3)}});function d(e){a.innerHTML="";const t=e.startsWith("http://")||e.startsWith("https://")||e.startsWith("www."),n=t?function(e){if(e.includes("youtube.com")||e.includes("youtu.be")){let t="";return t=e.includes("youtu.be")?e.split("/").pop().split("?")[0]:new URL(e).searchParams.get("v"),t?`https://www.youtube.com/embed/${t}?autoplay=1&mute=1&controls=0&modestbranding=1&rel=0&loop=1&playlist=${t}`:null}if(e.includes("vimeo.com")){return`https://player.vimeo.com/video/${e.split("/").pop().split("?")[0]}?autoplay=1&muted=1&loop=1&title=0&byline=0&portrait=0`}if(e.includes("dailymotion.com")){return`https://www.dailymotion.com/embed/video/${e.split("/").pop().split("_")[0]}?autoplay=1&mute=1&controls=0`}return null}(e):null;if(n)console.log("Media is a link"),a.innerHTML=`\n                <iframe\n                    width="100%"\n                    height="100%"\n                    src="${n}"\n                    frameborder="0"\n                    allow="autoplay; encrypted-media"\n                    allowfullscreen>\n                </iframe>\n            `;else if(e.endsWith(".mp4")||e.endsWith(".webm")||e.endsWith(".ogg")||t&&(e.includes(".mp4")||e.includes(".webm")||e.includes(".ogg"))){console.log("Media is a video",e);let n="";e.endsWith(".mp4")||t&&e.includes(".mp4")?n="video/mp4":e.endsWith(".webm")||t&&e.includes(".webm")?n="video/webm":(e.endsWith(".ogg")||t&&e.includes(".ogg"))&&(n="video/ogg"),a.innerHTML=`\n                <video id="player" style="object-fit: cover; width:100%; height:100%;" autoplay muted loop playsinline>\n                    <source src="${e}" type="${n}" />\n                    Your browser does not support the video tag.\n                </video>\n            `;const o=document.getElementById("player");if(o){new Plyr(o)}}else e.endsWith(".jpeg")||e.endsWith(".jpg")||e.endsWith(".png")||t&&(e.includes(".jpeg")||e.includes(".jpg")||e.includes(".png"))?(console.log("Media is an image",e),a.innerHTML=`\n                <img id="imgContainer" style="object-fit: cover; width:100%; height:100%;" src="${e}" alt="Image"/>\n            `):(console.log("Unsupported media."),a.innerHTML="Unsupported media format.")}r.addEventListener("lyrics",function(e){try{const t=JSON.parse(e.data).data.split(/\r?\n/);t.length>0&&/^\$[a-zA-Z]/.test(t[0])&&t.shift();const n=t.join("\n");s.textContent=n,console.log("Cleaned lyrics:",n)}catch(t){console.error("Failed to parse lyrics event:",t,e.data)}}),r.addEventListener("settings",function(e){}),r.addEventListener("clear",function(e){console.log("clear received."),s.textContent="",l.textContent="HWVCI Presenter"}),r.addEventListener("theme",function(e){var t=JSON.parse(e.data);let n;n="application/json"===t.type?JSON.parse(t.data):t;n.id;const o=n.font,a=n.font_size,l=n.font_color,r=n.bold,d=n.italic,c=n.strike_through,p=n.top_left_offset,u=n.top_middle_offset,f=n.top_right_offset,g=n.left_upper_offset,m=n.right_upper_offset,y=n.left_middle_offset,h=n.right_middle_offset,v=n.left_lower_offset,b=n.right_lower_offset,w=n.left_bottom_offset,E=n.middle_bottom_offset,L=n.right_bottom_offset,_=(n.text_align,n.justify_content,n.align_items,p+u+f),k=w+E+L,x=g+y+v,S=m+h+b;s.style.marginTop=_+"px",s.style.marginBottom=k+"px",s.style.marginLeft=x+"px",s.style.marginRight=S+"px",s.style.fontFamily=o,s.style.fontSize=a+"px",s.style.color=l,r&&(s.style.fontWeight="bold"),d&&(s.style.fontStyle="italic"),c&&(s.style.textDecoration="line-through"),s.style.textAlign=n.text_align,i.style.justifyContent=n.justify_content,i.style.alignItems=n.align_items}),r.addEventListener("verse",function(t){const n=JSON.parse(t.data);console.log("verse is",n.data),e.post("/searchbibleverse",n,e=>{if(e.ok){let t="",n="";const o=e.data;o.length>1&&(t="\n\n");const i=o.length,a=Object.keys(o[0]).length;for(let e=0;e<a;e++){let s="";for(let n=0;n<i;n++)s+=o[n][Object.keys(o[n])[e]]+t;for(let t=0;t<i;t++){n=Object.keys(o[t])[e]}}s.textContent=verse,l.textContent=n}},e=>{console.error("Error getting verse",e)},!0)}),r.addEventListener("versebackground",function(e){JSON.parse(e.data).data}),r.addEventListener("versebackgroundopacity",function(e){JSON.parse(e.data)}),r.addEventListener("media",function(e){}),r.addEventListener("hidelyrics",function(e){s.style.visibility="hidden"}),r.addEventListener("blackscreen",function(e){s.style.visibility="hidden",a.innerHTML="",l.show=!1}),r.addEventListener("showdesktop",function(e){}),r.addEventListener("showlyrics",function(e){s.style.visibility="visible",l.show=!0}),r.addEventListener("removebackground",function(e){a.innerHTML=""}),r.addEventListener("title",function(e){const t=JSON.parse(e.data);l.textContent=t.data.replaceAll('"',"")}),r.addEventListener("changebackground",function(t){let n=JSON.parse(t.data).data.replaceAll('"',"");if("link"===n)e.get("/getlink",e=>{e.ok?(console.log(e.link),d(e.link)):console.log("Failed to get link")},e=>{console.error("Error get bg link",e)},!0);else{d("uploaded/"+n)}}),r.addEventListener("connected",function(e){const t=JSON.parse(e.data);res=t.data.replaceAll('"',""),"true"===res&&(l.textContent="info")}),r.addEventListener("apmode",function(e){const t=JSON.parse(e.data).data.replaceAll('"',"");l.textContent=t}),r.addEventListener("presentation",function(n){const o=JSON.parse(n.data);console.log("presentation data is",o),async function(n){a.innerHTML='\n            <div class="reveal">\n                <div class="slides" id="revealSlides"></div>\n            </div>\n        ';const o=encodeURIComponent(n.data),i=new Promise((t,n)=>{e.get(`/list-files?dir=${o}`,e=>{e.ok?t(e.data):(console.error("Failed to list files"),n(new Error("Failed to list files")))},e=>{console.error("Error fetching file list:",e),n(e)},!0)});try{const e=await i,n=document.getElementById("revealSlides");e.forEach(e=>{const t=`/presentations/active/${encodeURIComponent(e)}`,o=document.createElement("section");o.innerHTML=`\n                    <img src="${t}"\n                         style="width:100%; height:100%; object-fit:contain; background:#000;">\n                `,n.appendChild(o)}),t||(t=new Reveal,await t.initialize({width:"100%",height:"100%",margin:0,minScale:1,maxScale:1,transition:"fade",controls:!0,progress:!1}),console.log("Reveal initialized"))}catch(e){console.error("Error loading presentation:",e)}}(o)}),r.addEventListener("next",function(e){t&&"function"==typeof t.next?t.next():console.warn("Reveal not ready for next")}),r.addEventListener("previous",function(e){t&&"function"==typeof t.prev?t.prev():console.warn("Reveal not ready for prev")}),r.addEventListener("versebackground",function(e){const t=JSON.parse(e.data);s.style.backgroundColor=function(e,t=100){3===(e=e.replace(/^#/,"")).length&&(e=e.split("").map(e=>e+e).join(""));const n=parseInt(e.slice(0,2),16),o=parseInt(e.slice(2,4),16),i=parseInt(e.slice(4,6),16);return`rgba(${n}, ${o}, ${i}, ${t})`}(t.data,n)}),r.addEventListener("backgroundopacity",function(e){!function(e){const t=Math.max(0,Math.min(1,e/100)),o=window.getComputedStyle(s);let i,a,l;const r=o.backgroundColor.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)/);r?(i=r[1],a=r[2],l=r[3]):(console.warn("No background color detected, defaulting to black"),i=a=l=0);n=t,s.style.backgroundColor=`rgba(${i}, ${a}, ${l}, ${t})`,console.log(`Background opacity set to ${e}% â†’ alpha: ${t}`)}(JSON.parse(e.data).data)})});