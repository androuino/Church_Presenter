<<<<<<< HEAD
const db=new Dexie("ServiceDB");db.version(1).stores({songs:"id, list",live:"id, lyricsId, lyrics"}),m2d2.load(e=>{e.dict.set({yes:{en:"YES"},no:{en:"NO"},ok:{en:"OK"},send:{en:"SEND"},cancel:{en:"CANCEL"}})}),m2d2.ready(e=>{const t=new EventSource("/events");let o=null,n=null,i="",s=!1,c=[];const l=e("#header"),a=e(".container"),r=e(".bubbles"),d=e("#mainControl",{navNew:{onclick:function(e){const t=`${window.location.protocol}/create`;window.open(t,"createWindow","width=800,height=600,toolbar=no,scrollbars=yes,resizable=yes")}},navEdit:{onclick:function(t){null===o?e.failure("Please select a song to edit."):h(n)}},navDelete:{onclick:function(t){null===o?e.failure("Please select a song to delete."):e.alert("Deleting...")}},navStartProjector:{onclick:function(t){e.post("/startprojector",e=>{e.ok&&console.log("Projector started.")},!0)}},navStopProjector:{onclick:function(t){e.post("/stopprojector",e=>{e.ok&&console.log("Projector stopped.")},!0)}},navInfo:{onclick:function(e){}},navWiFi:{onclick:function(e){const t=`${window.location.protocol}/wifisettings`;window.open(t,"wifiSettingWindow","width=800,height=400,toolbar=no,scrollbars=yes,resizable=yes")}},navSettings:{onclick:function(t){e.get("/settings",e=>{const t=`${window.location.protocol}/settings`;window.open(t,"settingsWindow","width=1200,height=700,toolbar=no,scrollbars=yes,resizable=yes")},!0)}},navLogout:{onclick:function(t){e.confirm("Are you want to log out?",t=>{t&&e.get("/logout.path",e=>{e.ok&&(l.show=!1,d.show=!1,a.show=!0,r.show=!0,localStorage.clear())})})}}}),g=e(".songs",{inputSearch:{onkeyup:function(t){let o=this.value.toUpperCase(),n=song.tableSong.getElementsByTagName("tr");if("Escape"===t.key){this.value="";for(let e=1;e<n.length;e++)n[e].style.display=""}else if(""===o)for(let e=1;e<n.length;e++)n[e].style.display="";else if("Enter"===t.key)if(""===this.value)e.failure("I did not get that!");else for(let e=1;e<n.length;e++){let t=n[e].getElementsByTagName("td"),i="";for(let e=0;e<t.length;e++)i+=t[e].textContent||t[e].innerText;i.toUpperCase().indexOf(o)>-1?n[e].style.display="":n[e].style.display="none"}}},iconSearch:{onclick:function(t){let o=inputSearch.value.toUpperCase(),n=g.tableSong.getElementsByTagName("tr");if(""===inputSearch.value)e.failure("I did not get that!");else for(let e=1;e<n.length;e++){let t=n[e].getElementsByTagName("td"),i="";for(let e=0;e<t.length;e++)i+=t[e].textContent||t[e].innerText;i.toUpperCase().indexOf(o)>-1?n[e].style.display="":n[e].style.display="none"}}},tableSong:{},tbodySongList:{template:{tr:{tagName:"tr",author:{tagName:"td",css:"author"},songTitle:{tagName:"td",css:"songTitle"},deleteSong:{tagName:"td",css:"deleteSong",span:{tagName:"span",id:"iconDeleteSong",css:"gicon",text:"delete_forever",style:{color:"red"},onload:function(e){tippy(this,{content:"Delete forever",interactive:!1,placement:"top",animation:"scale"})},onclick:function(t){null!=n?e.confirm("Confirmation to delete this song?",t=>{t&&e.delete("/deletesong/"+n,t=>{t.ok?(e.success("Song is deleted."),f()):e.failure("Something went wrong.")},!0)}):e.alert("Please pick a song on the list.")}}},editSong:{tagName:"td",css:"editSong",span:{tagName:"span",id:"iconEditSong",css:"gicon",text:"edit_document",onload:function(e){tippy(this,{content:"Edit",interactive:!1,placement:"top",animation:"scale"})},onclick:function(t){null!=n?h(n):e.alert("Please pick a song on the list.")}}},toService:{tagName:"td",css:"toService",span:{tagName:"span",id:"iconAddToService",css:"gicon",text:"playlist_add",onload:function(e){tippy(this,{content:"Add to service",interactive:!1,placement:"top",animation:"scale"})},onclick:function(t){null!=n?e.get("/getsongtitle/"+n,e=>{e.ok?(i=e.title,p.ulSongs.items.push({dataset:{id:n},pSongTitle:{dataset:{id:n},text:e.title}})):console.debug("There's an error getting the song title.")},!0):e.alert("Please click a song on the list.")}}},onclick:function(e){n=this.dataset.id,o=n,this.classList.add("active"),g.tbodySongList.items.forEach(e=>{if(e.dataset.id!=n)e.classList.remove("active"),e.style.background="";else{e.style.background="#ffee00";const t=e.querySelectorAll("td")[1];t&&(i=t.textContent,c.push([n,i]))}}),S("songs",c)},onmouseover:function(e){n=this.dataset.id}}},items:[]}}),p=e(".live",{clearLive:{onclick:function(t){p.ulLiveLyrics.items.length>0?e.confirm("Confirm to clear.",t=>{t&&(e.post("/liveclear",e=>{e.ok&&(console.debug("Live cleared."),L("live"))},e=>{console.error("Error clearing live.",e)},!0),p.ulLiveLyrics.items.clear(),p.ulSongs.items.forEach(e=>{const t=e.children[0];t.classList.contains("active")?(t.classList.remove("active"),t.classList.contains("live")?(t.style.color="black",t.style.background="#3ff53f"):(t.style.color="",t.style.background="")):t.classList.contains("live")&&(t.classList.remove("live"),t.style.color="",t.style.background="")}))}):e.post("/liveclear",e=>{e.ok&&console.debug("Live cleared.")},e=>{console.error("Error clearing live.",e)},!0)}},controlDefault:{onclick:function(t){e.post("/showlyrics",e=>{e.ok&&console.debug("lyrics is shown.")},e=>{console.error("error showing lyrics.",e)},!0)}},controlBlackScreen:{onclick:function(t){e.post("/blackscreen",e=>{e.ok&&console.debug("black screen activated.")},e=>{console.error("error setting screen to black.",e)},!0)}},controlHideLyrics:{onclick:function(t){e.post("/hidelyrics",e=>{e.ok&&console.debug("lyrics is hidden.")},e=>{console.error("error hiding lyrics.",e)},!0)}},controlRemoveBackground:{onclick:function(t){e.post("/removebackground",e=>{e.ok&&console.debug("remove background success.")},e=>{console.error("error removing background",e)},!0)}},ulLiveLyrics:{template:{li:{tagName:"li",onclick:function(t){const o=this.dataset.id;this.classList.add("active"),p.ulLiveLyrics.items.forEach(t=>{if(o!==t.dataset.id)t.classList.remove("active");else{const o={lyrics:t.text};e.post("/stream",o,e=>{e.ok&&console.debug("lyrics sent.")},!0)}})}}},items:[],onkeyup:function(e){this.getElementsByTagName("li");console.log(e.key)}},ulSongs:{template:{li:{tagName:"li",pSongTitle:{tagName:"p",id:"pSongTitle",onload:function(e){tippy(this,{content:"Click to view the lyrics",interactive:!1,placement:"top",animation:"scale"})},onclick:function(t){const o=t.target.dataset.id;this.classList.add("active"),p.lyricsHeader.text=this.text+" song lyrics",p.lyricsHeader.style.color="#ffee00",e.get("/getsonglyrics/"+o,e=>{if(e.ok){p.lyricsContainer.items.clear(),(e.data?.match(/\$\w[\s\S]*?(?=\$\w|$)/g)||[]).forEach(e=>{let t=e.trim();t&&p.lyricsContainer.items.push({dataset:{id:o},innerHTML:t.replace(/\n/g,"<br>")})}),p.ulSongs.items.forEach(e=>{const t=e.children[0];o===t.dataset.id?this.classList.contains("live")&&(this.style.background="linear-gradient(to right, #ffee00, #3ff53f)"):(t.classList.remove("active"),t.classList.contains("live")?(t.style.color="black",t.style.background="#3ff53f"):(t.style.color="",t.style.background=""))})}},!0)}},spanRemove:{tagName:"span",id:"spanRemove",css:"gicon",text:"delete",style:{color:"red"},onload:function(e){tippy(this,{content:"Remove from service",interactive:!1,placement:"top",animation:"scale"})}},spanEdit:{tagName:"span",id:"spanEdit",css:"gicon",text:"edit_document",style:{color:"#3be3c6"},onload:function(e){tippy(this,{content:"Edit on the go",interactive:!1,placement:"top",animation:"scale"})}},spanToLive:{tagName:"span",id:"spanToLive",css:"gicon",text:"play_arrow",style:{color:"#3ff53f"},onload:function(e){tippy(this,{content:"To live",interactive:!1,placement:"top",animation:"scale"})},onclick:function(t){let o,n=0;p.ulSongs.items.forEach(e=>{const t=e.children[0];this===e.children[3]?(o=e.children[3],n=t.dataset.id,t.classList.add("live"),t.classList.contains("active")?t.style.background="linear-gradient(to right, #ffee00, #3ff53f)":(t.style.color="black",t.style.background="#3ff53f")):(t.classList.remove("live"),t.classList.contains("active")?t.style.background="#ffee00":(t.style.color="",t.style.background=""))}),e.get("/getsonglyrics/"+n,e=>{if(e.ok){p.ulLiveLyrics.items.clear();let t=e.data?.match(/\$\w[\s\S]*?(?=\$\w|$)/g)||[];const o={lyricsId:n,blocks:t};console.log("toDB is",o),S("live",o),t.forEach(e=>{let t=e.trim();t&&p.ulLiveLyrics.items.push({pre:{tagName:"pre",text:t},innerHTML:t.replace(/\n/g,"<br>")})})}},!0)}}}},items:[],onclick:function(e){if(e.target.id&&e.target.id.startsWith("spanRemove")){const t=e.target.closest("li"),o=t.querySelector("p");console.log(t.dataset.id),console.log(o.text);const n=c.findIndex(e=>e[0]===t.dataset.id&&e[1]===o.text);-1!==n&&c.splice(n,1),console.log(c),S("songs",c),this.removeChild(t),p.lyricsHeader.text="SONG'S LYRICS",p.lyricsContainer.items.clear()}}},controlCloseEditMode:{onclick:function(t){p.lyricsContainer.items.length>0&&e.confirm("Confirm to close editing?",e=>{e&&p.lyricsContainer.items.clear()})}},controlClearSongList:{onclick:function(t){p.ulSongs.items.length>0&&e.confirm("Confirm to clear the song list?",t=>{t&&(p.ulSongs.items.clear(),e.post("/liveclear",e=>{e.ok&&console.debug("Live cleared.")},e=>{console.error("Error clearing live.",e)},!0),p.ulLiveLyrics.items.clear(),p.lyricsContainer.items.clear(),L("songs"))})}},controlViewLive:{onclick:function(t){e.alert("Sorry, this is not implemented yet.")}},controlPreview:{onclick:function(e){const t=`${window.location.protocol}/`;window.open(t,"previewWindow","width=800,height=600,toolbar=no,scrollbars=yes,resizable=yes")}},lyricsHeader:{},lyricsContainer:{template:{li:{tagName:"li",style:{borderBottom:"1px solid white"},ondblclick:function(e){this.contentEditable=!0,this.focus(),this.style.backgroundColor="yellow",this.style.color="black"},onblur:function(t){this.contentEditable=!1,this.style.backgroundColor="",this.style.color="";let o="";p.lyricsContainer.items.forEach(e=>{o+=e.text+"\n"});const n={id:this.dataset.id,lyrics:o.trimEnd()};e.post("/saveeditedsong",n,t=>{t.ok?E[0].show():e.failure("Something's wrong saving your edits.")},!0)},onkeydown:function(e){"Enter"!==e.key||e.shiftKey||(document.execCommand("insertHTML",!1,"<br><br>"),e.preventDefault())}}},items:[]}});!async function(){db.live.get("live").then(e=>{if(e){p.ulLiveLyrics.items.clear();e.lyricsId;e.lyrics.forEach(e=>{let t=e.trim();t&&p.ulLiveLyrics.items.push({pre:{tagName:"pre",text:t},innerHTML:t.replace(/\n/g,"<br>")})})}else console.log("No saved live song")}),db.songs.get("songs").then(e=>{e?e.list.forEach(e=>{const t=e[0],o=e[1];c.push([t,o]),p.ulSongs.items.push({dataset:{id:t},pSongTitle:{dataset:{id:t},text:o}})}):console.log("No saved song list")})}();e("#resizer",{onmousedown:function(e){s=!0,document.body.style.cursor="col-resize"}});document.addEventListener("mousemove",e=>{if(!s)return;const t=u.getBoundingClientRect(),o=e.clientX-t.left;g.style.flexBasis=`${o}px`,p.style.flexBasis=`calc(100% - ${o}px - 4px)`}),document.addEventListener("mouseup",()=>{s=!1,document.body.style.cursor="default"});const u=e(".wrapper",{onload:function(t){e.get("/checksessions",e=>{e.ok?(a.show=!1,r.show=!1,l.show=!0,d.show=!0,f(),localStorage.setItem("login",!0)):(l.show=!1,d.show=!1,a.show=!0,r.show=!0,localStorage.clear())},!0)}}),m=e(".form"),v=e("#inputUsername"),y=e("#inputPassword");e("#loginButton",{onclick:function(t){t.preventDefault();const o=v.value,n=y.value;if(""===o||""===n)e.failure("Username or Password cannot be empty!");else{const t={user:o,pass:n};e.post("/login.path",t,t=>{t.ok?(m.show=!1,u.classList.add("form-success"),localStorage.setItem("login",!0),location.reload()):e.failure("Error: ",t.message)},!0)}}});function f(){e.get("/getsongs",e=>{e.ok?(g.tbodySongList.items.clear(),e.data.forEach(e=>{g.tbodySongList.items.push({dataset:{id:e.id},author:{text:e.author},songTitle:{text:e.songTitle}})})):console.debug("Error getting all the songs")})}function h(t){e.get("/editsong/"+t,e=>{if(e.ok){localStorage.setItem("data",JSON.stringify(e.data));const t=`${window.location.protocol}/create`;window.open(t,"createWindow","width=800,height=600,toolbar=no,scrollbars=yes,resizable=yes")}})}t.addEventListener("wifi",function(e){"connected"===JSON.parse(JSON.parse(e.data)).status?d.navWiFi.style.color="green":d.navWiFi.style.color=""});const k=p.ulLiveLyrics.getElementsByTagName("li");let w=-1;function b(e){w>=0&&k[w].classList.remove("active"),w+=e;const t=k[w];t.classList.add("active"),t.scrollIntoView({block:"nearest"}),console.log(t)}async function S(e,t){try{switch(e){case"live":if(console.log("Saving live data:",t),!t.lyricsId||!t.blocks)return void console.error("Invalid data for live store: lyricsId or blocks missing");await db.live.put({id:"live",lyricsId:t.lyricsId,lyrics:t.blocks});const o=await db.live.get("live");console.log("Saved live song - ID:",o.lyricsId,"Lyrics:",o.lyrics);break;case"songs":if(console.log("Saving songs data:",t),!t)return void console.error("Invalid data for songs store: id or list missing");await db.songs.put({id:"songs",list:t});const n=await db.songs.get("songs");console.log("Saved song list - ID:",n.id,"List:",n.list);break;default:console.warn("Unknown key for saveToLocalDB:",e)}}catch(e){console.error("Error saving to local DB:",e)}}async function L(e){switch(e){case"live":await db.live.delete("live");break;case"songs":await db.songs.delete("songs"),await db.live.delete("live")}}document.addEventListener("keydown",function(e){console.log(e.key),"ArrowDown"===e.key?(e.preventDefault(),w<k.length-1&&b(1)):"ArrowUp"===e.key&&(e.preventDefault(),w>0&&b(-1))}),tippy(".navNew",{content:"Create a new song",interactive:!0,placement:"right",animation:"scale"}),tippy(".navEdit",{content:"Edit an existing song",interactive:!0,placement:"right",animation:"scale"}),tippy(".navDelete",{content:"Delete a song",interactive:!0,placement:"right",animation:"scale"}),tippy(".navStartProjector",{content:"Start Projector",interactive:!0,placement:"right",animation:"scale"}),tippy(".navStopProjector",{content:"Stop Projector",interactive:!0,placement:"right",animation:"scale"}),tippy(".navInfo",{allowHTML:!0,content:"About",interactive:!0,placement:"right",animation:"scale"}),tippy(".navWiFi",{content:"Connect the server to a wifi network",interactive:!0,placement:"right",animation:"scale"}),tippy(".navSettings",{content:"Settings",interactive:!0,placement:"right",animation:"scale"}),tippy(".navLogout",{content:"Log out",interactive:!0,placement:"right",animation:"scale"}),tippy("#iconSearch",{content:"Search",interactive:!0,placement:"top",animation:"scale"}),tippy(".lyricsContainer",{content:"Double click to edit",interactive:!1,placement:"top",animation:"scale"}),tippy(".clearLive",{content:"Clear live",interactive:!1,placement:"top",animation:"scale"});const E=tippy(".lyricsContainer",{content:"Save edit success!",interactive:!1,placement:"top",trigger:"manual",animation:"scale"});tippy(".controlDefault",{content:"Default screen",interactive:!1,placement:"top",animation:"scale"}),tippy(".controlBlackScreen",{content:"Set screen to black",interactive:!1,placement:"top",animation:"scale"}),tippy(".controlHideLyrics",{content:"Hide the lyric",interactive:!1,placement:"top",animation:"scale"}),tippy(".controlRemoveBackground",{content:"Remove the background",interactive:!1,placement:"top",animation:"scale"}),tippy(".controlCloseEditMode",{content:"Clear editing",interactive:!1,placement:"top",animation:"scale"}),tippy(".controlClearSongList",{content:"Clear song list",interactive:!1,placement:"top",animation:"scale"}),tippy(".controlViewLive",{content:"Live view",interactive:!1,placement:"top",animation:"scale"}),tippy(".controlPreview",{content:"Preview",interactive:!1,placement:"top",animation:"scale"})});
=======
const db=new Dexie("ServiceDB");db.version(1).stores({songs:"id, list",live:"id, lyricsId, lyrics"}),m2d2.load(e=>{e.dict.set({yes:{en:"YES"},no:{en:"NO"},ok:{en:"OK"},send:{en:"SEND"},cancel:{en:"CANCEL"}})}),m2d2.ready(e=>{const t=new EventSource("/events");let o=null,n=null,i="",s=!1,c=[];const l=e("#header"),a=e(".container"),r=e(".bubbles"),d=e("#mainControl",{navNew:{onclick:function(e){const t=`${window.location.protocol}/create`;window.open(t,"createWindow","width=800,height=600,toolbar=no,scrollbars=yes,resizable=yes")}},navEdit:{onclick:function(t){null===o?e.failure("Please select a song to edit."):h(n)}},navDelete:{onclick:function(t){null===o?e.failure("Please select a song to delete."):e.alert("Deleting...")}},navStartProjector:{onclick:function(t){e.post("/startprojector",e=>{e.ok&&console.log("Projector started.")},!0)}},navStopProjector:{onclick:function(t){e.post("/stopprojector",e=>{e.ok&&console.log("Projector stopped.")},!0)}},navInfo:{onclick:function(e){}},navWiFi:{onclick:function(e){const t=`${window.location.protocol}/wifisettings`;window.open(t,"wifiSettingWindow","width=800,height=400,toolbar=no,scrollbars=yes,resizable=yes")}},navSettings:{onclick:function(t){e.get("/settings",e=>{const t=`${window.location.protocol}/settings`;window.open(t,"settingsWindow","width=1200,height=700,toolbar=no,scrollbars=yes,resizable=yes")},!0)}},navLogout:{onclick:function(t){e.confirm("Are you want to log out?",t=>{t&&e.get("/logout",e=>{e.ok&&(l.show=!1,d.show=!1,a.show=!0,r.show=!0,localStorage.clear())})})}}}),g=e(".songs",{inputSearch:{onkeyup:function(t){let o=this.value.toUpperCase(),n=song.tableSong.getElementsByTagName("tr");if("Escape"===t.key){this.value="";for(let e=1;e<n.length;e++)n[e].style.display=""}else if(""===o)for(let e=1;e<n.length;e++)n[e].style.display="";else if("Enter"===t.key)if(""===this.value)e.failure("I did not get that!");else for(let e=1;e<n.length;e++){let t=n[e].getElementsByTagName("td"),i="";for(let e=0;e<t.length;e++)i+=t[e].textContent||t[e].innerText;i.toUpperCase().indexOf(o)>-1?n[e].style.display="":n[e].style.display="none"}}},iconSearch:{onclick:function(t){let o=inputSearch.value.toUpperCase(),n=g.tableSong.getElementsByTagName("tr");if(""===inputSearch.value)e.failure("I did not get that!");else for(let e=1;e<n.length;e++){let t=n[e].getElementsByTagName("td"),i="";for(let e=0;e<t.length;e++)i+=t[e].textContent||t[e].innerText;i.toUpperCase().indexOf(o)>-1?n[e].style.display="":n[e].style.display="none"}}},tableSong:{},tbodySongList:{template:{tr:{tagName:"tr",author:{tagName:"td",css:"author"},songTitle:{tagName:"td",css:"songTitle"},deleteSong:{tagName:"td",css:"deleteSong",span:{tagName:"span",id:"iconDeleteSong",css:"gicon",text:"delete_forever",style:{color:"red"},onload:function(e){tippy(this,{content:"Delete forever",interactive:!1,placement:"top",animation:"scale"})},onclick:function(t){null!=n?e.confirm("Confirmation to delete this song?",t=>{t&&e.delete("/deletesong/"+n,t=>{t.ok?(e.success("Song is deleted."),f()):e.failure("Something went wrong.")},!0)}):e.alert("Please pick a song on the list.")}}},editSong:{tagName:"td",css:"editSong",span:{tagName:"span",id:"iconEditSong",css:"gicon",text:"edit_document",onload:function(e){tippy(this,{content:"Edit",interactive:!1,placement:"top",animation:"scale"})},onclick:function(t){null!=n?h(n):e.alert("Please pick a song on the list.")}}},toService:{tagName:"td",css:"toService",span:{tagName:"span",id:"iconAddToService",css:"gicon",text:"playlist_add",onload:function(e){tippy(this,{content:"Add to service",interactive:!1,placement:"top",animation:"scale"})},onclick:function(t){null!=n?e.get("/getsongtitle/"+n,e=>{e.ok?(i=e.title,p.ulSongs.items.push({dataset:{id:n},pSongTitle:{dataset:{id:n},text:e.title}})):console.debug("There's an error getting the song title.")},!0):e.alert("Please click a song on the list.")}}},onclick:function(e){n=this.dataset.id,o=n,this.classList.add("active"),g.tbodySongList.items.forEach(e=>{if(e.dataset.id!=n)e.classList.remove("active"),e.style.background="";else{e.style.background="#ffee00";const t=e.querySelectorAll("td")[1];t&&(i=t.textContent,c.push([n,i]))}}),S("songs",c)},onmouseover:function(e){n=this.dataset.id}}},items:[]}}),p=e(".live",{clearLive:{onclick:function(t){p.ulLiveLyrics.items.length>0?e.confirm("Confirm to clear.",t=>{t&&(e.post("/liveclear",e=>{e.ok&&(console.debug("Live cleared."),L("live"))},e=>{console.error("Error clearing live.",e)},!0),p.ulLiveLyrics.items.clear(),p.ulSongs.items.forEach(e=>{const t=e.children[0];t.classList.contains("active")?(t.classList.remove("active"),t.classList.contains("live")?(t.style.color="black",t.style.background="#3ff53f"):(t.style.color="",t.style.background="")):t.classList.contains("live")&&(t.classList.remove("live"),t.style.color="",t.style.background="")}))}):e.post("/liveclear",e=>{e.ok&&console.debug("Live cleared.")},e=>{console.error("Error clearing live.",e)},!0)}},controlDefault:{onclick:function(t){e.post("/showlyrics",e=>{e.ok&&console.debug("lyrics is shown.")},e=>{console.error("error showing lyrics.",e)},!0)}},controlBlackScreen:{onclick:function(t){e.post("/blackscreen",e=>{e.ok&&console.debug("black screen activated.")},e=>{console.error("error setting screen to black.",e)},!0)}},controlHideLyrics:{onclick:function(t){e.post("/hidelyrics",e=>{e.ok&&console.debug("lyrics is hidden.")},e=>{console.error("error hiding lyrics.",e)},!0)}},controlRemoveBackground:{onclick:function(t){e.post("/removebackground",e=>{e.ok&&console.debug("remove background success.")},e=>{console.error("error removing background",e)},!0)}},ulLiveLyrics:{template:{li:{tagName:"li",onclick:function(t){const o=this.dataset.id;this.classList.add("active"),p.ulLiveLyrics.items.forEach(t=>{if(o!==t.dataset.id)t.classList.remove("active");else{const o={lyrics:t.text};e.post("/stream",o,e=>{e.ok&&console.debug("lyrics sent.")},!0)}})}}},items:[],onkeyup:function(e){this.getElementsByTagName("li");console.log(e.key)}},ulSongs:{template:{li:{tagName:"li",pSongTitle:{tagName:"p",id:"pSongTitle",onload:function(e){tippy(this,{content:"Click to view the lyrics",interactive:!1,placement:"top",animation:"scale"})},onclick:function(t){const o=t.target.dataset.id;this.classList.add("active"),p.lyricsHeader.text=this.text+" song lyrics",p.lyricsHeader.style.color="#ffee00",e.get("/getsonglyrics/"+o,e=>{if(e.ok){p.lyricsContainer.items.clear(),(e.data?.match(/\$\w[\s\S]*?(?=\$\w|$)/g)||[]).forEach(e=>{let t=e.trim();t&&p.lyricsContainer.items.push({dataset:{id:o},innerHTML:t.replace(/\n/g,"<br>")})}),p.ulSongs.items.forEach(e=>{const t=e.children[0];o===t.dataset.id?this.classList.contains("live")&&(this.style.background="linear-gradient(to right, #ffee00, #3ff53f)"):(t.classList.remove("active"),t.classList.contains("live")?(t.style.color="black",t.style.background="#3ff53f"):(t.style.color="",t.style.background=""))})}},!0)}},spanRemove:{tagName:"span",id:"spanRemove",css:"gicon",text:"delete",style:{color:"red"},onload:function(e){tippy(this,{content:"Remove from service",interactive:!1,placement:"top",animation:"scale"})}},spanEdit:{tagName:"span",id:"spanEdit",css:"gicon",text:"edit_document",style:{color:"#3be3c6"},onload:function(e){tippy(this,{content:"Edit on the go",interactive:!1,placement:"top",animation:"scale"})}},spanToLive:{tagName:"span",id:"spanToLive",css:"gicon",text:"play_arrow",style:{color:"#3ff53f"},onload:function(e){tippy(this,{content:"To live",interactive:!1,placement:"top",animation:"scale"})},onclick:function(t){let o,n=0;p.ulSongs.items.forEach(e=>{const t=e.children[0];this===e.children[3]?(o=e.children[3],n=t.dataset.id,t.classList.add("live"),t.classList.contains("active")?t.style.background="linear-gradient(to right, #ffee00, #3ff53f)":(t.style.color="black",t.style.background="#3ff53f")):(t.classList.remove("live"),t.classList.contains("active")?t.style.background="#ffee00":(t.style.color="",t.style.background=""))}),e.get("/getsonglyrics/"+n,e=>{if(e.ok){p.ulLiveLyrics.items.clear();let t=e.data?.match(/\$\w[\s\S]*?(?=\$\w|$)/g)||[];const o={lyricsId:n,blocks:t};console.log("toDB is",o),S("live",o),t.forEach(e=>{let t=e.trim();t&&p.ulLiveLyrics.items.push({pre:{tagName:"pre",text:t},innerHTML:t.replace(/\n/g,"<br>")})})}},!0)}}}},items:[],onclick:function(e){if(e.target.id&&e.target.id.startsWith("spanRemove")){const t=e.target.closest("li"),o=t.querySelector("p");console.log(t.dataset.id),console.log(o.text);const n=c.findIndex(e=>e[0]===t.dataset.id&&e[1]===o.text);-1!==n&&c.splice(n,1),console.log(c),S("songs",c),this.removeChild(t),p.lyricsHeader.text="SONG'S LYRICS",p.lyricsContainer.items.clear()}}},controlCloseEditMode:{onclick:function(t){p.lyricsContainer.items.length>0&&e.confirm("Confirm to close editing?",e=>{e&&p.lyricsContainer.items.clear()})}},controlClearSongList:{onclick:function(t){p.ulSongs.items.length>0&&e.confirm("Confirm to clear the song list?",t=>{t&&(p.ulSongs.items.clear(),e.post("/liveclear",e=>{e.ok&&console.debug("Live cleared.")},e=>{console.error("Error clearing live.",e)},!0),p.ulLiveLyrics.items.clear(),p.lyricsContainer.items.clear(),L("songs"))})}},controlViewLive:{onclick:function(t){e.alert("Sorry, this is not implemented yet.")}},controlPreview:{onclick:function(e){const t=`${window.location.protocol}/`;window.open(t,"previewWindow","width=800,height=600,toolbar=no,scrollbars=yes,resizable=yes")}},lyricsHeader:{},lyricsContainer:{template:{li:{tagName:"li",style:{borderBottom:"1px solid white"},ondblclick:function(e){this.contentEditable=!0,this.focus(),this.style.backgroundColor="yellow",this.style.color="black"},onblur:function(t){this.contentEditable=!1,this.style.backgroundColor="",this.style.color="";let o="";p.lyricsContainer.items.forEach(e=>{o+=e.text+"\n"});const n={id:this.dataset.id,lyrics:o.trimEnd()};e.post("/saveeditedsong",n,t=>{t.ok?E[0].show():e.failure("Something's wrong saving your edits.")},!0)},onkeydown:function(e){"Enter"!==e.key||e.shiftKey||(document.execCommand("insertHTML",!1,"<br><br>"),e.preventDefault())}}},items:[]}});!async function(){db.live.get("live").then(e=>{if(e){p.ulLiveLyrics.items.clear();e.lyricsId;e.lyrics.forEach(e=>{let t=e.trim();t&&p.ulLiveLyrics.items.push({pre:{tagName:"pre",text:t},innerHTML:t.replace(/\n/g,"<br>")})})}else console.log("No saved live song")}),db.songs.get("songs").then(e=>{e?e.list.forEach(e=>{const t=e[0],o=e[1];c.push([t,o]),p.ulSongs.items.push({dataset:{id:t},pSongTitle:{dataset:{id:t},text:o}})}):console.log("No saved song list")})}();e("#resizer",{onmousedown:function(e){s=!0,document.body.style.cursor="col-resize"}});document.addEventListener("mousemove",e=>{if(!s)return;const t=u.getBoundingClientRect(),o=e.clientX-t.left;g.style.flexBasis=`${o}px`,p.style.flexBasis=`calc(100% - ${o}px - 4px)`}),document.addEventListener("mouseup",()=>{s=!1,document.body.style.cursor="default"});const u=e(".wrapper",{onload:function(t){e.get("/checksessions",e=>{e.ok?(console.log("session is active"),a.show=!1,r.show=!1,l.show=!0,d.show=!0,f(),localStorage.setItem("login",!0)):(console.log("session is deactivated"),l.show=!1,d.show=!1,a.show=!0,r.show=!0,localStorage.clear())},!0)}}),m=e(".form"),v=e("#inputUsername"),y=e("#inputPassword");e("#loginButton",{onclick:function(t){t.preventDefault();const o=v.value,n=y.value;if(""===o||""===n)e.failure("Username or Password cannot be empty!");else{const t={user:o,pass:n};e.post("/login",t,t=>{t.ok?(m.show=!1,u.classList.add("form-success"),localStorage.setItem("login",!0),location.reload()):e.failure("Error: ",t.message)},!0)}}});function f(){e.get("/getsongs",e=>{e.ok?(g.tbodySongList.items.clear(),e.data.forEach(e=>{g.tbodySongList.items.push({dataset:{id:e.id},author:{text:e.author},songTitle:{text:e.songTitle}})})):console.debug("Error getting all the songs")})}function h(t){e.get("/editsong/"+t,e=>{if(e.ok){localStorage.setItem("data",JSON.stringify(e.data));const t=`${window.location.protocol}/create`;window.open(t,"createWindow","width=800,height=600,toolbar=no,scrollbars=yes,resizable=yes")}})}t.addEventListener("wifi",function(e){"connected"===JSON.parse(JSON.parse(e.data)).status?d.navWiFi.style.color="green":d.navWiFi.style.color=""});const k=p.ulLiveLyrics.getElementsByTagName("li");let w=-1;function b(e){w>=0&&k[w].classList.remove("active"),w+=e;const t=k[w];t.classList.add("active"),t.scrollIntoView({block:"nearest"}),console.log(t)}async function S(e,t){try{switch(e){case"live":if(console.log("Saving live data:",t),!t.lyricsId||!t.blocks)return void console.error("Invalid data for live store: lyricsId or blocks missing");await db.live.put({id:"live",lyricsId:t.lyricsId,lyrics:t.blocks});const o=await db.live.get("live");console.log("Saved live song - ID:",o.lyricsId,"Lyrics:",o.lyrics);break;case"songs":if(console.log("Saving songs data:",t),!t)return void console.error("Invalid data for songs store: id or list missing");await db.songs.put({id:"songs",list:t});const n=await db.songs.get("songs");console.log("Saved song list - ID:",n.id,"List:",n.list);break;default:console.warn("Unknown key for saveToLocalDB:",e)}}catch(e){console.error("Error saving to local DB:",e)}}async function L(e){switch(e){case"live":await db.live.delete("live");break;case"songs":await db.songs.delete("songs"),await db.live.delete("live")}}document.addEventListener("keydown",function(e){console.log(e.key),"ArrowDown"===e.key?(e.preventDefault(),w<k.length-1&&b(1)):"ArrowUp"===e.key&&(e.preventDefault(),w>0&&b(-1))}),tippy(".navNew",{content:"Create a new song",interactive:!0,placement:"right",animation:"scale"}),tippy(".navEdit",{content:"Edit an existing song",interactive:!0,placement:"right",animation:"scale"}),tippy(".navDelete",{content:"Delete a song",interactive:!0,placement:"right",animation:"scale"}),tippy(".navStartProjector",{content:"Start Projector",interactive:!0,placement:"right",animation:"scale"}),tippy(".navStopProjector",{content:"Stop Projector",interactive:!0,placement:"right",animation:"scale"}),tippy(".navInfo",{allowHTML:!0,content:"About",interactive:!0,placement:"right",animation:"scale"}),tippy(".navWiFi",{content:"Connect the server to a wifi network",interactive:!0,placement:"right",animation:"scale"}),tippy(".navSettings",{content:"Settings",interactive:!0,placement:"right",animation:"scale"}),tippy(".navLogout",{content:"Log out",interactive:!0,placement:"right",animation:"scale"}),tippy("#iconSearch",{content:"Search",interactive:!0,placement:"top",animation:"scale"}),tippy(".lyricsContainer",{content:"Double click to edit",interactive:!1,placement:"top",animation:"scale"}),tippy(".clearLive",{content:"Clear live",interactive:!1,placement:"top",animation:"scale"});const E=tippy(".lyricsContainer",{content:"Save edit success!",interactive:!1,placement:"top",trigger:"manual",animation:"scale"});tippy(".controlDefault",{content:"Default screen",interactive:!1,placement:"top",animation:"scale"}),tippy(".controlBlackScreen",{content:"Set screen to black",interactive:!1,placement:"top",animation:"scale"}),tippy(".controlHideLyrics",{content:"Hide the lyric",interactive:!1,placement:"top",animation:"scale"}),tippy(".controlRemoveBackground",{content:"Remove the background",interactive:!1,placement:"top",animation:"scale"}),tippy(".controlCloseEditMode",{content:"Clear editing",interactive:!1,placement:"top",animation:"scale"}),tippy(".controlClearSongList",{content:"Clear song list",interactive:!1,placement:"top",animation:"scale"}),tippy(".controlViewLive",{content:"Live view",interactive:!1,placement:"top",animation:"scale"}),tippy(".controlPreview",{content:"Preview",interactive:!1,placement:"top",animation:"scale"})});
>>>>>>> ktor
